{% extends "snippets/base.html" %} {% block title %}{{ title }}{% endblock %} {% block content %}

<div id="messages_container" class="container">
  <!-- New message button -->
  <a href="{% url 'messages:create' %}"><button class="btn btn-default" type="button" id="create_message">
    <i class="fa fa-pencil"></i></button></a>
  <!-- Inbox/Sent filters -->
  <div id="message_labels_container">
    <a href="{% url 'messages:inbox' %}" class="btn btn-default label active">Inbox</a>
    <a href="{% url 'messages:sent' %}" class="btn btn-default label">Sent</a>
  </div>
  <!-- Private Messages -->
  <div id="pm_list">
    {% for object in object_list reversed %}
    <div class="message_container">
      <!-- Title --><h2 class="message_title">{{ object.subject }}</h2>
      <!-- If inbox show author, if sent show contact -->
      {% if sent %}
      <span class="message_info">
        to <a href="{% url 'accounts:profile' user=object.contact.username %}"><b class="contact">{{ object.contact }}</b></a>
         {{ object.created|timesince }} ago
      </span>
      {% else %}
      <span class="message_info">
        from <a href="{% url 'accounts:profile' user=object.author.username %}"><b class="author">{{ object.author }}</b></a>
        {{ object.created|timesince }} ago
      </span>
      {% endif %}
      <!-- Content -->
      <p class="message_content">{{ object.content }}</p>

      <!-- If inbox show options -->
      {% if not sent %}
      <b><a href="{% url 'messages:delete' pk=object.pk %}" class="edit_and_delete">Delete</a></b>
      <b><a href="javascript:" class="edit_and_delete reply_pm">Reply</a></b>

      <form class="reply_form" action="{% url 'messages:reply' contact=object.author.username pk=object.pk %}" method="post">{% csrf_token %} {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary cancel_reply">Cancel</button>
      </form>
      {% endif %}

      <!-- If the object or the parent have replies (a thread) show option -->
      {% if object.replies.all or object.parent.replies.all %}
      <a href="javascript:" class="replies_link">Show Thread<i class="fa fa-caret-down"></i></a>

      <!-- Replies -->
      <div class="show_replies">
        <!-- If the object don't have a parent (it is the parent) show the replies -->
        {% if not object.parent %} {% for reply in object.replies.all %}
        {% include 'snippets/message-replies.html' %}
        <!-- If the object has a parent show the parent and then the replies -->
        {% endfor %} {% else %}
        <!-- Parent -->
        <div class="thread_message">
          <h3 class="message_title">{{ object.parent.subject }}</h3>
          <span class="message_info">from <b class="author">{{ object.parent.author }}</b> to <b class="contact">{{ object.parent.contact }}</b> {{ object.parent.created|timesince }} ago</span>
          <p class="message_content">
            {{ object.parent.content }}
          </p>
        </div>
        <!-- Replies -->
        {% for reply in object.parent.replies.all %}
        {% include 'snippets/message-replies.html' %}
        {% endfor %} {% endif %}
      </div>{% endif %}
    </div>{% endfor %}
  </div>

</div>
{%block head %}
<script>
  var loc = window.location.pathname;
  $('#message_labels_container').find('.label').each(function() {
    $(this).toggleClass('active', $(this).attr('href') == loc);
  });
</script>
{% endblock %}
{% endblock %}
